{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _this = this,\n    _jsxFileName = \"/Users/Nick/Documents/ServeVue/react-auth/with-cookie-auth-fauna/pages/profile.js\";\n\nimport _JSXStyle from \"styled-jsx/style\";\nimport React from \"react\";\nvar __jsx = React.createElement;\nimport cookie from 'cookie';\nimport Router from 'next/router';\nimport { withAuthSync } from '../utils/auth';\nimport { FAUNA_SECRET_COOKIE } from '../utils/fauna-auth';\nimport { profileApi } from './api/profile';\nimport Layout from '../components/layout';\n\nvar Profile = function Profile(props) {\n  var userId = props.userId;\n  return __jsx(Layout, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 12,\n      columnNumber: 5\n    }\n  }, __jsx(\"h1\", {\n    className: \"jsx-1519313982\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 13,\n      columnNumber: 7\n    }\n  }, \"Your user id is \", userId), __jsx(_JSXStyle, {\n    id: \"1519313982\",\n    __self: _this\n  }, \"h1.jsx-1519313982{margin-bottom:0;}\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9OaWNrL0RvY3VtZW50cy9TZXJ2ZVZ1ZS9yZWFjdC1hdXRoL3dpdGgtY29va2llLWF1dGgtZmF1bmEvcGFnZXMvcHJvZmlsZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFja0IsQUFHMkIsZ0JBQ2xCIiwiZmlsZSI6Ii9Vc2Vycy9OaWNrL0RvY3VtZW50cy9TZXJ2ZVZ1ZS9yZWFjdC1hdXRoL3dpdGgtY29va2llLWF1dGgtZmF1bmEvcGFnZXMvcHJvZmlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb29raWUgZnJvbSAnY29va2llJ1xuaW1wb3J0IFJvdXRlciBmcm9tICduZXh0L3JvdXRlcidcbmltcG9ydCB7IHdpdGhBdXRoU3luYyB9IGZyb20gJy4uL3V0aWxzL2F1dGgnXG5pbXBvcnQgeyBGQVVOQV9TRUNSRVRfQ09PS0lFIH0gZnJvbSAnLi4vdXRpbHMvZmF1bmEtYXV0aCdcbmltcG9ydCB7IHByb2ZpbGVBcGkgfSBmcm9tICcuL2FwaS9wcm9maWxlJ1xuaW1wb3J0IExheW91dCBmcm9tICcuLi9jb21wb25lbnRzL2xheW91dCdcblxuY29uc3QgUHJvZmlsZSA9IHByb3BzID0+IHtcbiAgY29uc3QgeyB1c2VySWQgfSA9IHByb3BzXG5cbiAgcmV0dXJuIChcbiAgICA8TGF5b3V0PlxuICAgICAgPGgxPllvdXIgdXNlciBpZCBpcyB7dXNlcklkfTwvaDE+XG5cbiAgICAgIDxzdHlsZSBqc3g+e2BcbiAgICAgICAgaDEge1xuICAgICAgICAgIG1hcmdpbi1ib3R0b206IDA7XG4gICAgICAgIH1cbiAgICAgIGB9PC9zdHlsZT5cbiAgICA8L0xheW91dD5cbiAgKVxufVxuXG5Qcm9maWxlLmdldEluaXRpYWxQcm9wcyA9IGFzeW5jIGN0eCA9PiB7XG4gIGNvbnNvbGUubG9nKGN0eClcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3R4XG4gICAgY29uc3QgY29va2llcyA9IGNvb2tpZS5wYXJzZShyZXEuaGVhZGVycy5jb29raWUgPz8gJycpXG4gICAgY29uc3QgZmF1bmFTZWNyZXQgPSBjb29raWVzW0ZBVU5BX1NFQ1JFVF9DT09LSUVdXG5cbiAgICBpZiAoIWZhdW5hU2VjcmV0KSB7XG4gICAgICByZXMud3JpdGVIZWFkKDMwMiwgeyBMb2NhdGlvbjogJy9sb2dpbicgfSlcbiAgICAgIHJlcy5lbmQoKVxuICAgICAgcmV0dXJuIHt9XG4gICAgfVxuXG4gICAgY29uc3QgcHJvZmlsZUluZm8gPSBhd2FpdCBwcm9maWxlQXBpKGZhdW5hU2VjcmV0KVxuXG4gICAgcmV0dXJuIHsgdXNlcklkOiBwcm9maWxlSW5mbyB9XG4gIH1cblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCcvYXBpL3Byb2ZpbGUnKVxuXG4gIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMSkge1xuICAgIFJvdXRlci5wdXNoKCcvbG9naW4nKVxuICAgIHJldHVybiB7fVxuICB9XG4gIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihhd2FpdCByZXNwb25zZS50ZXh0KCkpXG4gIH1cblxuICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpXG5cbiAgcmV0dXJuIHsgdXNlcklkOiBkYXRhLnVzZXJJZCB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHdpdGhBdXRoU3luYyhQcm9maWxlKVxuIl19 */\\n/*@ sourceURL=/Users/Nick/Documents/ServeVue/react-auth/with-cookie-auth-fauna/pages/profile.js */\"));\n};\n\n_c = Profile;\n\nProfile.getInitialProps = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx) {\n    var _req$headers$cookie, req, res, cookies, faunaSecret, profileInfo, response, data;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            console.log(ctx);\n\n            if (!false) {\n              _context.next = 13;\n              break;\n            }\n\n            req = ctx.req, res = ctx.res;\n            cookies = cookie.parse((_req$headers$cookie = req.headers.cookie) !== null && _req$headers$cookie !== void 0 ? _req$headers$cookie : '');\n            faunaSecret = cookies[FAUNA_SECRET_COOKIE];\n\n            if (faunaSecret) {\n              _context.next = 9;\n              break;\n            }\n\n            res.writeHead(302, {\n              Location: '/login'\n            });\n            res.end();\n            return _context.abrupt(\"return\", {});\n\n          case 9:\n            _context.next = 11;\n            return profileApi(faunaSecret);\n\n          case 11:\n            profileInfo = _context.sent;\n            return _context.abrupt(\"return\", {\n              userId: profileInfo\n            });\n\n          case 13:\n            _context.next = 15;\n            return fetch('/api/profile');\n\n          case 15:\n            response = _context.sent;\n\n            if (!(response.status === 401)) {\n              _context.next = 19;\n              break;\n            }\n\n            Router.push('/login');\n            return _context.abrupt(\"return\", {});\n\n          case 19:\n            if (!(response.status !== 200)) {\n              _context.next = 25;\n              break;\n            }\n\n            _context.t0 = Error;\n            _context.next = 23;\n            return response.text();\n\n          case 23:\n            _context.t1 = _context.sent;\n            throw new _context.t0(_context.t1);\n\n          case 25:\n            _context.next = 27;\n            return response.json();\n\n          case 27:\n            data = _context.sent;\n            return _context.abrupt(\"return\", {\n              userId: data.userId\n            });\n\n          case 29:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function (_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexport default _c2 = withAuthSync(Profile);\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"Profile\");\n$RefreshReg$(_c2, \"%default%\");","map":{"version":3,"sources":["/Users/Nick/Documents/ServeVue/react-auth/with-cookie-auth-fauna/pages/profile.js"],"names":["cookie","Router","withAuthSync","FAUNA_SECRET_COOKIE","profileApi","Layout","Profile","props","userId","getInitialProps","ctx","console","log","req","res","cookies","parse","headers","faunaSecret","writeHead","Location","end","profileInfo","fetch","response","status","push","Error","text","json","data"],"mappings":";;;;;;;;;AAAA,OAAOA,MAAP,MAAmB,QAAnB;AACA,OAAOC,MAAP,MAAmB,aAAnB;AACA,SAASC,YAAT,QAA6B,eAA7B;AACA,SAASC,mBAAT,QAAoC,qBAApC;AACA,SAASC,UAAT,QAA2B,eAA3B;AACA,OAAOC,MAAP,MAAmB,sBAAnB;;AAEA,IAAMC,OAAO,GAAG,SAAVA,OAAU,CAAAC,KAAK,EAAI;AAAA,MACfC,MADe,GACJD,KADI,CACfC,MADe;AAGvB,SACE,MAAC,MAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBAAqBA,MAArB,CADF;AAAA;AAAA;AAAA,6vEADF;AAWD,CAdD;;KAAMF,O;;AAgBNA,OAAO,CAACG,eAAR;AAAA,sEAA0B,iBAAMC,GAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AACxBC,YAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;;AADwB;AAAA;AAAA;AAAA;;AAGdG,YAAAA,GAHc,GAGDH,GAHC,CAGdG,GAHc,EAGTC,GAHS,GAGDJ,GAHC,CAGTI,GAHS;AAIhBC,YAAAA,OAJgB,GAINf,MAAM,CAACgB,KAAP,wBAAaH,GAAG,CAACI,OAAJ,CAAYjB,MAAzB,qEAAmC,EAAnC,CAJM;AAKhBkB,YAAAA,WALgB,GAKFH,OAAO,CAACZ,mBAAD,CALL;;AAAA,gBAOjBe,WAPiB;AAAA;AAAA;AAAA;;AAQpBJ,YAAAA,GAAG,CAACK,SAAJ,CAAc,GAAd,EAAmB;AAAEC,cAAAA,QAAQ,EAAE;AAAZ,aAAnB;AACAN,YAAAA,GAAG,CAACO,GAAJ;AAToB,6CAUb,EAVa;;AAAA;AAAA;AAAA,mBAaIjB,UAAU,CAACc,WAAD,CAbd;;AAAA;AAahBI,YAAAA,WAbgB;AAAA,6CAef;AAAEd,cAAAA,MAAM,EAAEc;AAAV,aAfe;;AAAA;AAAA;AAAA,mBAkBDC,KAAK,CAAC,cAAD,CAlBJ;;AAAA;AAkBlBC,YAAAA,QAlBkB;;AAAA,kBAoBpBA,QAAQ,CAACC,MAAT,KAAoB,GApBA;AAAA;AAAA;AAAA;;AAqBtBxB,YAAAA,MAAM,CAACyB,IAAP,CAAY,QAAZ;AArBsB,6CAsBf,EAtBe;;AAAA;AAAA,kBAwBpBF,QAAQ,CAACC,MAAT,KAAoB,GAxBA;AAAA;AAAA;AAAA;;AAAA,0BAyBZE,KAzBY;AAAA;AAAA,mBAyBAH,QAAQ,CAACI,IAAT,EAzBA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mBA4BLJ,QAAQ,CAACK,IAAT,EA5BK;;AAAA;AA4BlBC,YAAAA,IA5BkB;AAAA,6CA8BjB;AAAEtB,cAAAA,MAAM,EAAEsB,IAAI,CAACtB;AAAf,aA9BiB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAA1B;;AAAA;AAAA;AAAA;AAAA;;AAiCA,qBAAeN,YAAY,CAACI,OAAD,CAA3B","sourcesContent":["import cookie from 'cookie'\nimport Router from 'next/router'\nimport { withAuthSync } from '../utils/auth'\nimport { FAUNA_SECRET_COOKIE } from '../utils/fauna-auth'\nimport { profileApi } from './api/profile'\nimport Layout from '../components/layout'\n\nconst Profile = props => {\n  const { userId } = props\n\n  return (\n    <Layout>\n      <h1>Your user id is {userId}</h1>\n\n      <style jsx>{`\n        h1 {\n          margin-bottom: 0;\n        }\n      `}</style>\n    </Layout>\n  )\n}\n\nProfile.getInitialProps = async ctx => {\n  console.log(ctx)\n  if (typeof window === 'undefined') {\n    const { req, res } = ctx\n    const cookies = cookie.parse(req.headers.cookie ?? '')\n    const faunaSecret = cookies[FAUNA_SECRET_COOKIE]\n\n    if (!faunaSecret) {\n      res.writeHead(302, { Location: '/login' })\n      res.end()\n      return {}\n    }\n\n    const profileInfo = await profileApi(faunaSecret)\n\n    return { userId: profileInfo }\n  }\n\n  const response = await fetch('/api/profile')\n\n  if (response.status === 401) {\n    Router.push('/login')\n    return {}\n  }\n  if (response.status !== 200) {\n    throw new Error(await response.text())\n  }\n\n  const data = await response.json()\n\n  return { userId: data.userId }\n}\n\nexport default withAuthSync(Profile)\n"]},"metadata":{},"sourceType":"module"}